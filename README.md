# Novel - 仿番茄小说App

基于 **Kotlin + React Native** 混合架构开发的小说阅读应用，采用现代化的开发模式和最佳实践。

## 🎯 项目简介

Novel App 是一个高性能的小说阅读应用，采用 **MVI + Repository + 单向数据流** 架构模式，Android 侧使用 **ViewModel/Hilt/Paging3/Room**，RN 侧使用 **Zustand + immer + middleware**，通过 **Shared Flow** 实现双端事件通信。

## 🚀 技术栈

### 前端 (React Native)
- **React Native 0.74** - 跨平台移动应用框架
- **TypeScript** - 类型安全的JavaScript超集
- **React Native Reanimated 3** - 高性能动画库
- **Zustand + immer** - 轻量级状态管理
- **React Navigation 7** - 导航路由管理
- **React Native Fast Image** - 图片加载优化

### Android 原生
- **Kotlin** - 现代化的JVM语言
- **Jetpack Compose** - 声明式UI框架
- **Hilt** - 依赖注入框架
- **Room + Paging3** - 数据库与分页
- **OkHttp 5 + Retrofit** - 网络请求
- **Coil-Compose** - 图片加载

### 缓存系统
- **NetworkCacheManager** - 通用网络缓存管理器，支持内存+磁盘双重缓存
- **CachedServiceExtensions** - 为所有Service提供缓存扩展方法
- **CachedBookRepository** - Repository模式实现，封装缓存逻辑
- **Cache-First策略** - 先从缓存获取数据，然后异步更新网络数据
- **SettingsUtils** - 设置工具类，提供缓存清理、大小计算、主题切换功能

### 设置与主题系统
- **混合架构设置页** - Compose导航栏 + RN内容区域完美融合
- **Zustand设置状态管理** - 统一设置状态，支持持久化存储
- **主题切换系统** - 浅色/深色/跟随系统，支持自动切换
- **自定义设置组件** - SettingRow组件支持多种交互类型
- **缓存管理集成** - 实时计算缓存大小，支持一键清空

## 📱 已实现功能

### ✅ 混合架构核心
- **Kotlin + React Native** - 混合架构，发挥两端优势
- **Hilt 依赖注入** - 模块化依赖管理
- **React Native Bridge** - 原生与RN双向通信
- **主题状态跨端同步** - Native ➜ RN ➜ Native 双向事件流，`ThemeStore.initializeFromNative` 首屏拉取 & `DeviceEventEmitter` 实时推送系统主题变化
- **NavigationPackage** - 自定义RN原生模块
- **智能缓存系统** - Cache-First策略，离线优先 & 实时同步

### ✅ Android Compose 原生实现

#### 🏠 首页 (HomePage)
- **MVI + Repository** - 完整的架构实现
- **HomeViewModel** - 状态管理与数据流控制
- **下拉刷新 + 上拉加载** - SwipeRefresh集成
- **书籍推荐系统** - 轮播图、热门、新书、VIP书籍
- **分类筛选器** - 动态分类加载与切换
- **榜单功能** - 访问榜、收藏榜等多种榜单
- **瀑布流布局** - 高性能的书籍展示
- **搜索功能** - 实时搜索与结果展示
- **书籍点击导航** - 点击书籍跳转到详情页
- **3D翻转卡片动画** - 封面沿左边Y轴旋转90度，内容同步放大到全屏
- **邻页预加载功能** - 分类筛选器和榜单页预加载

#### 📖 书籍详情页 (BookDetailPage)
- **模块化架构** - 组件化设计，职责分离
  - `components/` - UI组件：封面、标题、作者、统计、简介、书评
  - `viewmodel/` - 业务逻辑：BookDetailViewModel + BookDetailUiState  
  - `utils/` - 工具类：数据处理和格式化
- **MVI + StateHolder** - 统一状态管理架构
- **LoadingStateComponent** - 加载、错误、空状态处理
- **书籍信息展示** - 封面、标题、作者、分类信息
- **统计数据** - 评分、阅读人数、字数、更新时间
- **简介展开/收起** - HTML标签清理与文本展示
- **底部弹窗** - 点击"更多"展示完整简介
- **热门书评** - 星级评分、用户评论展示
- **iOS 风格侧滑返回** - ios 侧滑返回，并自带指示器和震动提示
- **3D翻转返回动画** - 倒放动画支持，从详情页返回时的合书效果
- **左滑进入阅读器** - **新增功能** 向左滑动手势快速进入阅读模式，详情页作为阅读器第0页

#### 📚 小说阅读器 (ReaderPage) - **架构重构 + 全书管理**
- **全书内容架构** - MVI + Repository + BookCacheManager，支持全书一次性加载
- **智能缓存系统**
  - **全书内容缓存** - 一次获取全书，两周过期自动清理
  - **增量更新机制** - 基于章节ID比较，只获取新增章节
  - **分字号页数缓存** - 不同字体大小的页数分别缓存存储
  - **渐进页数计算** - 后台计算全书页数，UI实时显示当前进度
- **沉浸式阅读体验**
  - **点击显示/隐藏控制栏** - 沉浸式阅读模式
  - **顶部控制栏** - 返回按钮，半透明覆盖
  - **底部控制栏** - 基于全书绝对页数的进度条和导航
  - **实时页数更新** - 计算期间显示"页数+"，完成后显示确切总数
- **全书导航系统**
  - **绝对页数跳转** - 基于全书总页数的精确跳转
  - **章节智能定位** - 根据绝对页数自动定位对应章节
  - **章节列表侧滑面板** - 75%宽度左侧面板，支持VIP标识
  - **当前位置高亮** - 在全书页数中准确显示当前阅读位置
- **阅读进度管理** - **新增功能**
  - **自动保存阅读位置** - 实时保存当前阅读的绝对页数
  - **跨设备同步** - 阅读进度云端同步，多设备无缝切换
  - **上次阅读位置恢复** - 进入阅读器自动跳转到上次阅读位置
  - **智能书签系统** - 自动生成阅读历史书签
- **阅读设置功能** - **四大设置模块 + 智能缓存**
  - **亮度调节** - 滑动条调节屏幕亮度
  - **字体大小** - 44档字体大小精确控制(12-44px)，分字号缓存页数
  - **背景主题** - 5种预设主题：护眼绿、经典白、温暖黄、夜间黑、羊皮纸
  - **翻页效果** - 5种翻页动画：仿真、覆盖、平移、上下、无动画
  - **外部点击关闭** - 点击设置面板外部区域自动关闭
- **详情页集成** - 书籍详情页作为阅读器第0页，支持所有翻页效果
  - **无缝翻页体验** - 从详情页翻到正文，统一的翻页动画
  - **统一手势控制** - 详情页内点击同样呼出阅读控制栏
  - **自动翻页** - 左滑进入时自动执行翻页动画到正文

#### 🔍 搜索模块

**核心功能：**
- **搜索历史管理** - 本地存储搜索记录，支持展开/收起，一键清空
- **热门榜单展示** - 点击榜、推荐榜、新书榜三重推荐，数据实时更新
- **完整榜单页面** - 超过15条数据时显示"查看完整榜单>"链接，支持折叠式顶部栏动画
- **高级筛选功能** - 多维度筛选：更新状态、VIP状态、字数范围、排序方式
- **智能搜索建议** - 基于历史记录的搜索建议和关键词高亮

#### 📱 **多种翻页模式实现** - **核心新功能 + 重大修复 + PageCurl集成**
- **六种翻页效果 + 翻页逻辑修复 + 纸张纹理**：
  - **书卷翻页** - **新增** 真实的书页卷曲翻页效果（基于PageCurl库）
  - **覆盖翻页** - **重新实现** 新页面从侧边滑入覆盖当前页
  - **平移翻页** - **重大修复** ViewPager风格翻页系统
  - **上下滚动** - **连贯阅读模式** 保持原有优秀体验 + **纸张纹理**
  - **无动画翻页** - **手势优化** 直接切换，适合快速阅读 + **纸张纹理**
- **✅ 章节切换逻辑修复** - **重大用户体验改进**
- **智能分页系统** - **PageSplitter工具类重大升级**
- **章节预缓存机制** - **无感翻页体验**
- **翻页逻辑优化** - **修复翻页无响应问题**
- **用户交互优化** - **设置面板体验提升**
- **智能交互设计**

#### 🧭 导航系统 (NavigationUtil)
- **NavHost路由** - 支持参数化路由导航
- **NavViewModel** - 统一导航管理
- **页面跳转** - 首页 ↔ 书籍详情页 ↔ 登录页 ↔ 阅读器页 ↔ 搜索页
- **参数传递** - 书籍ID、章节ID、搜索关键词等数据传递
- **返回导航** - 完整的页面栈管理
- **返回事件流** - SharedFlow支持的返回动画触发
- **手势导航** - **新增功能** 支持左滑手势进入阅读器，详情页无缝集成到阅读器
- **搜索页面集成** - **新增功能** 首页搜索框点击直接跳转到搜索页面

#### 🎨 动画系统 (FlipBookAnimation)
- **共享元素动画** - 双视图翻书体验，原始榜单图片参与动画
- **真实翻书效果**：封面沿左边Y轴旋转90度，内容同步放大到全屏
- **智能侧滑返回** - 集成iOS风格指示器的侧滑返回系统
- **精确3D变换** - 基于test文件夹算法改进的Camera旋转
- **透视修正** - 修复失真问题，确保视觉效果自然
- **缩放中心点计算** - 基于marginLeft/marginTop的精确算法
- **分离式动画** - 独立的旋转和缩放动画控制
- **全局覆盖层** - 突破组件边界的动画渲染
- **双向动画支持** - 打开书籍和合上书籍的完整动画流程
- **性能优化** - 60fps实时更新，硬件加速渲染，智能状态清理

#### 🛠️ 工具类库 (Utils)
- **NovelDateFormatter** - 智能时间格式化工具
- **StringProvider** - 抽象化Android资源访问
- **SecurityConfig** - 统一安全配置管理
- **ReactNativeBridge** - 双端事件通信桥梁
- **PageSplitter** - **新增** 智能文本分页工具类
- **AdaptiveScreen** - 屏幕适配工具，针对 Compose 与 RN 统一的 `wp/hp/fp/sp` 像素转换，自动根据设备尺寸缩放 UI
- **DebounceClickable** - 防抖点击扩展，Compose/RN 统一防重复点击，避免多次触发事件
- **NovelImageView** - 基于 **Coil** 的高性能图片加载组件，双级缓存 + 优雅占位 + 智能重试
- **PhoneInfoUtil** - 系统信息工具，异步获取手机号与运营商，兼容 Android 13 权限模型
- **RCTDeviceEventEmitter** - Android → RN 事件发射器封装，统一 Native 事件发送入口
- **NativeEventListener** - RN 侧原生事件监听器，支持用户数据、书籍数据秒级同步
- **GlobalFlipBookAnimationController** - 全局 3D 翻书动画控制器 & Overlay，跨页面共享动画状态
- **ReactRootView 缓存机制** - `ReactNativePage` 复用 RootView，秒级切换 RN 页面并保持组件状态

#### 🔐 登录页面 (LoginPage)
- **登录注册功能** - 手机号验证码登录
- **动画交互** - 丰富的页面切换动画
- **运营商识别** - 智能识别手机号运营商
- **输入验证** - 表单验证与错误提示
- **协议确认** - 用户协议和隐私政策

#### 🧭 底部导航
- **HorizontalPager** - 流畅的页面切换
- **五大模块** - 首页、分类、福利、书架、我的
- **状态保持** - 页面状态自动保存

### ✅ React Native 实现

#### 👤 我的页面 (ProfilePage)
- **模块化架构** - 职责分离，代码可维护性强  
- **下拉刷新** - 智能触发机制，流畅的状态切换
- **瀑布流布局** - 高性能的书籍展示
- **滚动动画** - 丰富的交互动效
  - 动态高度变化 
  - 图标透明度渐变  
  - 广告隐藏动画
- **主题系统** - 完整的主题色彩方案
- **TypeScript** - 完整的类型定义
- **设置页面集成** - 顶部导航栏设置按钮，overlay模式展示设置页

#### ⚙️ 设置页面 (SettingsPage) - **新增功能**
- **混合架构实现** - Android Compose顶部导航 + RN内容区域完美融合
- **缓存管理系统**
  - **智能缓存清理** - 计算并显示缓存大小，支持一键清空
  - **缓存大小计算** - 实时统计内部缓存、外部缓存、图片缓存等
  - **格式化显示** - 自动转换为GB/MB/KB单位显示
- **主题切换功能**
  - **夜间模式切换** - 浅色/深色/跟随系统三种模式
  - **自动切换** - 支持定时切换夜间模式
  - **跟随系统主题** - 自动跟随系统明暗主题设置
- **应用设置管理**
  - **通知设置** - 推送通知、福利通知开关
  - **字体大小调节** - 多档字体大小选择
  - **网络优化** - 网络设置与优化选项
  - **隐私设置** - 青少年模式等隐私保护功能
- **客服与关于**
  - **客服支持** - 快速联系客服功能
  - **关于页面** - 应用版本信息和相关说明
- **Zustand状态管理** - 完整的设置状态管理，支持本地持久化
- **自定义组件库** - SettingRow组件支持多种设置项类型
- **导航集成** - 与ProfilePage无缝集成，支持返回动画

## 🔗 相关链接

- **后端接口**: [novel-cloud](https://github.com/201206030/novel-cloud)

## 📝 开发计划

### 🚧 进行中
- [ ] 用户登录/注册完善
- [ ] 搜索功能优化
- [ ] 阅读进度云同步

### ✅ 最新完成 (v1.8.1) - Service 层架构重构
- [x] **统一异步处理** - **新增** `SafeService` 基类和 `DispatcherProvider`，封装协程调度和异常处理，简化 Service 实现。
- [x] **健壮的缓存管理** - **新增** `SessionCache` 接口和 `LruSessionCache` 实现，替换手动 LRU 缓存，提高稳定性和可测试性。
- [x] **配置中心化** - **新增** `ReaderServiceConfig`，集中管理所有 Service 的魔法值和配置项。
- [x] **标准化日志** - **新增** `ServiceLogger` 接口，统一日志格式，便于调试和性能监控。
- [x] **服务职责分离** - **重构** `SettingsService`，将其逻辑拆分为 `SettingsParser` 和 `SettingsSaver`，遵循单一职责原则。
- [x] **依赖注入集成** - **新增** `ServiceModule.kt` Hilt 模块，统一提供 Service 层基础设施的实例。
- [x] **核心服务重构** - **重构** `ChapterService`, `SettingsService`, `PaginationService` 以使用新的架构，提升代码质量。

### ✅ 最新完成 (v1.8.0) - **设置页面完整实现**
- [x] **混合架构设置页** - **新增** Android Compose顶部导航 + RN内容区域，完美融合双端优势
- [x] **智能缓存管理** - **核心功能** 缓存大小计算、格式化显示、一键清空功能
- [x] **主题切换系统** - **新增** 浅色/深色/跟随系统三种模式，支持自动切换和跟随系统
- [x] **设置状态管理** - **新增** Zustand store管理所有设置项，支持本地持久化
- [x] **自定义组件库** - **新增** SettingRow组件，支持开关、箭头、动作等多种类型
- [x] **导航系统集成** - **优化** ProfilePage设置按钮，overlay模式展示，无缝返回动画
- [x] **应用设置完善** - **新增** 通知设置、字体大小、网络优化、隐私设置等完整功能
- [x] **SettingsUtils工具类** - **新增** Android侧设置工具类，支持缓存管理和主题切换
- [x] **构建系统优化** - **修复** 编译错误，确保混合架构项目正常构建

### ✅ v1.7.0 - **搜索模块重大优化**
- [x] **FullRankingPage滚动修复** - **修复** 将`exitUntilCollapsedScrollBehavior`改为`pinnedScrollBehavior`，解决上滑无响应问题
- [x] **SearchResultPage布局重构** - **优化** 筛选按钮固定在分类标签上方，防止分类标签闪现
- [x] **分类筛选器优化** - **重新设计** 筛选按钮与分类标签分离布局，提升用户体验
- [x] **页面布局稳定性** - **修复** 分类标签条件加载逻辑，避免界面闪烁
- [x] **滚动行为优化** - **改进** 榜单页面滚动体验，支持双向滚动

### ✅ v1.6.0 - **智能缓存系统**
- [x] **NetworkCacheManager** - **新增** 通用网络缓存管理器，支持内存+磁盘双重缓存
- [x] **CachedServiceExtensions** - **新增** 为所有Service提供缓存扩展方法
- [x] **CachedBookRepository** - **新增** Repository模式实现，封装缓存逻辑和状态管理
- [x] **Cache-First策略** - **核心功能** 先从缓存获取数据，然后异步更新网络数据
- [x] **BookDetailViewModel缓存集成** - 书籍详情页使用缓存优先策略
- [x] **HomeRepository缓存优化** - 首页数据使用智能缓存策略
- [x] **SearchRepository缓存支持** - 搜索结果缓存，提升搜索体验
- [x] **ReaderViewModel缓存增强** - 阅读器章节和内容使用缓存策略
- [x] **依赖注入配置** - 完整的Hilt模块配置，支持缓存系统
- [x] **缓存管理功能** - 支持缓存清理、强制刷新、缓存状态检查

### ✅ v1.5.1 完成内容
- [x] **API架构调整** - **重大修复** 将不存在的全书API改为使用现有getBookChapters + getBookContent逐个获取
- [x] **逐章获取优化** - 先获取章节列表，再逐个获取章节内容，支持增量更新和容错处理
- [x] **缓存兼容性** - 保持原有缓存架构，支持部分缓存的增量更新机制
- [x] **错误处理改进** - 单章节获取失败不影响其他章节，提高系统稳定性
- [x] **编译错误修复** - 修复ReaderViewModel重构后的所有编译错误
- [x] **组件参数统一** - 修复翻页组件中缺失的onNavigateToReader参数
- [x] **类型安全增强** - 添加缺失的Log导入和兼容性字段
- [x] **构建验证通过** - 完整编译和构建测试通过，确保代码质量
- [x] **搜索模块开发** - **全新功能** 完整的搜索页面架构实现
- [x] **搜索历史管理** - 基于NovelUserDefaults的统一存储方案
- [x] **搜索榜单系统** - 三大热门榜单实时数据展示
- [x] **搜索页面导航集成** - 首页搜索框一键跳转功能
- [x] **嵌套滚动修复** - 解决LazyVerticalGrid和LazyColumn嵌套导致的布局崩溃问题
- [x] **阅读进度管理** - **新增功能** 上次阅读位置恢复和智能书签系统

### ✅ v1.5.0 - 全书架构重构
- [x] **全书架构重构** - **重大架构更新** 从单章节改为全书内容管理，支持一次性获取
- [x] **智能缓存系统** - 两周过期自动清理，基于章节ID的增量更新机制
- [x] **全书页数统计** - 总页数基于全书内容计算，支持不同字号分别缓存
- [x] **渐进页数计算** - 后台计算全书页数，UI实时显示"页数+"直到计算完成
- [x] **绝对页数导航** - 基于全书的绝对页数进行精确跳转和进度管理
- [x] **增量内容更新** - 新章节发布时只获取新增部分，无需重新下载全书
- [x] **分字号页数缓存** - 不同字体大小、屏幕尺寸的页数分别缓存
- [x] **BookCacheManager** - 新增专业缓存管理器，支持内容和页数双重缓存
- [x] **实时页数更新** - 页数计算期间每秒更新显示，提供即时反馈

### 📋 待开发
- [ ] 个人中心
- [ ] 书架管理
- [ ] 离线阅读
- [ ] 夜间模式切换
- [ ] 书签管理
- [ ] 阅读统计
- [ ] 阅读器更多手势支持

## 👥 贡献指南

1. Fork 项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建 Pull Request

## 📄 许可证

本项目基于 MIT 许可证开源 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🤝 致谢

感谢所有为这个项目做出贡献的开发者！

---

> 💡 **提示**: 这是一个学习项目，展示了现代移动应用开发的最佳实践。


## 📝 版本历史

### v1.8.0 - 设置页面完整实现版 (2024年12月) - **新功能**
- 🛠️ **混合架构设置页** - Android Compose顶部导航栏 + RN内容区域，展示混合架构的设计优势
- 💾 **智能缓存管理系统** - 缓存大小实时计算、格式化显示、一键清空，支持多种缓存类型
- 🎨 **完整主题切换** - 浅色/深色/跟随系统三种模式，支持自动切换和系统跟随
- ⚙️ **全面应用设置** - 通知管理、字体调节、网络优化、隐私保护等完整设置功能
- 🏗️ **状态管理优化** - Zustand store统一管理设置状态，支持本地持久化存储
- 🎯 **组件库扩展** - SettingRow自定义组件，支持开关、箭头、动作等多种交互类型
- 🔧 **构建系统修复** - 解决混合架构项目编译错误，确保项目稳定构建

### v1.5.0 - 全书架构重构版 (2024年12月) - **重大更新**
- 🏗️ **全书内容管理** - 从单章节获取改为全书内容一次性获取，支持增量更新
- 💾 **智能缓存系统** - 两周过期自动清理，根据章节ID智能增量更新
- 📊 **全书页数统计** - 总页数基于全书内容计算，支持不同字号分别缓存
- ⚡ **渐进页数计算** - 页数计算期间实时更新显示，每秒刷新当前进度
- 🔄 **增量内容更新** - 新章节发布时只获取新增部分，无需重新下载全书
- 🎯 **绝对页数导航** - 基于全书的绝对页数进行导航和进度管理
- 📝 **智能页数缓存** - 不同字号、屏幕尺寸的页数分别缓存，提升响应速度

### v1.4.0 - 翻页效果重构版 (2024年12月)
- 📖 **仿真翻页重构** - 真实书本卷曲质感，Math.PI算法驱动的自然弯曲效果
- 🎯 **平移翻页重构** - 采用Compose HorizontalPager，ViewPager风格流畅体验
- 💫 **覆盖翻页重构** - 显示下一页内容，动态阴影深度效果
- 📚 **上下滚动优化** - 章节无缝衔接，自动预缓存下一章内容
- 🧠 **预缓存扩展** - 从5章扩展到8章缓存（前后各3章），支持无缝阅读
- 🎨 **章节标题优化** - 只在每章第一页显示，提升内容显示面积

### v1.3.0 - 翻页性能优化版 (2024年12月)
- ⚡ **翻页效果重构** - 仿真、覆盖、平移三种效果完全重写
- 🎯 **手势系统优化** - 敏感度提升3倍，阈值优化，边界条件修复
- 📖 **分页算法升级** - 章节标题只在第一页显示，智能断点，HTML处理统一  
- 🔧 **用户交互提升** - 设置面板外部点击关闭，半透明遮罩效果
- 🐛 **问题修复** - 翻页无响应、页面状态不同步、边界条件错误等问题

### v1.2.0 (当前版本)
- ⚡ 3D翻书动画性能优化
- 🔧 iOS风格侧滑返回优化  
- 📱 图片加载性能提升
- 🎯 状态管理优化

### v1.1.0
- 🎨 3D翻书动画基础实现
- 📋 榜单组件开发
- 🏠 主页架构完善

### v1.0.0
- 🚀 项目初始化
- 🏗️ MVI架构搭建
- 📱 基础UI组件

---